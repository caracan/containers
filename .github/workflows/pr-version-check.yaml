name: PR Container Version Validator
description: Workflow that runs when renovate submits a PR, the purpose being to bump the version.json so we build a new version on merge
on:
  pull_request:
    branches: [ main ]
    paths:
      - 'caddy/**'
      - 'keepalived/**'
      - 'ansible-toolbox/**'
      - 'keepalived-init/**'

jobs:
  check-and-bump:
    if: contains(github.event.pull_request.user.login, 'renovate') || contains(github.event.pull_request.labels.*.name, 'renovate-update')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        id: checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Process Bumps
        id: process
        run: |
          UPDATED_ANY=false
          MODIFIED_SERVICES=""
          touch modified_files.txt

          for DIR in caddy/ keepalived/ ansible-toolbox/ keepalived-init/; do
            if [ -f "${DIR}version.json" ]; then
              DIFF=$(git diff --name-only origin/main...HEAD -- "$DIR" | grep -v "version.json" || true)
              V_CHECK=$(git diff --name-only origin/main...HEAD -- "${DIR}version.json" || true)

              if [ -n "$DIFF" ] && [ -z "$V_CHECK" ]; then
                jq '.["z-stream"] |= (tonumber + 1 | tostring) | .version = "\(.major).\(.minor).\(.["z-stream"])"' "${DIR}version.json" > temp.json && mv temp.json "${DIR}version.json"
                echo "${DIR}version.json" >> modified_files.txt
                MODIFIED_SERVICES+="${DIR%/}, "
                UPDATED_ANY=true
              fi
            fi
          done
          echo "updated=$UPDATED_ANY" >> $GITHUB_OUTPUT
          echo "services=${MODIFIED_SERVICES%, }" >> $GITHUB_OUTPUT

      - name: Commit and Push
        if: steps.process.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          cat modified_files.txt | xargs git add
          git commit -m "chore: auto-bump z-stream for ${{ steps.process.outputs.services }}"
          git push

#      - name: Telegram Notification
#        if: steps.process.outputs.updated == 'true'
#        env:
#          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
#          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
#        run: |
#          MSG="ðŸ›  *Automation Report*%0A"
#          MSG+="Repo: ${{ github.event.repository.name }}%0A"
#          MSG+="Services Updated: \`${{ steps.process.outputs.services }}\` %0A%0A"
#          MSG+="[View Pull Request](${{ github.event.pull_request.html_url }})"
#
#          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
#            -d "chat_id=$CHAT_ID" -d "text=$MSG" -d "parse_mode=Markdown" -d "disable_web_page_preview=true"